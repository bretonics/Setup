#!/usr/bin/env bash

#===============================================================================================
# PRE-LAUNCH SETUP
#===============================================================================================
source ./lib/functions
handle_getopts "$@"
loggers

#===============================================================================================
# START RUNNING SETUP
#===============================================================================================
welcome
header

#-----------------------------------------------------------------------------------------------
# SYSTEM SETUP
section "${EMOJI_BEER} INSTALLING HOMEBREW"

/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

message "Done installing Homebrew."
sleep 2

#-----------------------------------------------------------------------------------------------
# FULL INSTALL
# - Install all Formulae, Taps, and Mac Apps specified by $BREW_FILE 
if [ "$SETUP_MODE" = "FULL" ]; then
    section "INSTALLING EVERYTHING IN '${BREW_FILE}'"
    brew bundle --file ${BREW_FILE}

#-----------------------------------------------------------------------------------------------
# ESSENTIALS INSTALL
# - Homebrew Taps specified by $BREW_TAPS_FILE
# - Homebrew Forlumae specified by $BREW_FORMULAE_FILE
# - Homebrew Casks specified by $BREW_CASKS_FILE
# - applications from Mac App Store specified by $MAC_APPS_FILE
elif [ "$SETUP_MODE" = "ESSENTIALS" ]; then
    section "${EMOJI_TOOLBOX} INSTALLING HOMEBREW TAPS, FORMULAE, AND CASKS"

    subsection "Adding Homebrew Taps"
    while read -r tap; do
        echo "Adding tap $tap"
        brew tap $tap
    done < $BREW_TAPS_FILE
    message "Done adding Homebrew taps."
    sleep 2

    subsection "Installing Homebrew Formulae"
    while read -r formula; do
        echo "Installing $formula"
        brew install $formula
        echo ""
    done < $BREW_FORMULAE_FILE
    message "Done installing Homebrew formulae."
    sleep 2

    subsection "Installing Casks (3rd party apps)"
    while read -r cask; do
        echo "Installing $cask"
        brew cask install $cask
        echo ""
    done < $BREW_CASKS_FILE
    message "Done installing casks."
    sleep 2

    subsection "Installing Apps From Mac App Store"
    mas signin --dialog $(getAccountId)
    for app in $(sed -E -n 's/^([0-9]+)(.*)/\1/p' ${MAC_APPS_FILE}); do
        echo "Installing $app"
        mas install $app
        echo ""
    done
    message "Done installing Mac App Store apps."
    sleep 2

#-----------------------------------------------------------------------------------------------
# ERROR: INSTALL MODE NOT SUPPORTED
else
    msg error "Something is terribly wrong. ${SETUP_MODE} should have never passed."
    exit 1
fi

#-----------------------------------------------------------------------------------------------
# INSTALL CORE RESOURCES
section "INSTALLING CORE RESOURCES"

subsection "Installing Global NPM Packages"
# brew link --force node@10  # link keg-only package if installing node v10
npm install -g @angular/cli bunyan eslint aws-azure-login

subsection "Installing VS Code Extensions"
code --install-extension Shan.code-settings-sync

#-----------------------------------------------------------------------------------------------
# CLEANUP
section "${EMOJI_TRASH} CLEANING UP"

echo -e "Turning OFF sending brew analytics\n"
brew analytics off

echo -e "Cleaning up Homebrew downloads and caches\n"
brew cleanup -s # remove older versions in cellar + old downloads-cache
rm -rf $(brew --cache) # delete all

message "Done cleaning up."
sleep 2

#===============================================================================================
# COMPLETED
#===============================================================================================
footer "Primary"

#-----------------------------------------------------------------------------------------------
# SECONDARY INSTALL
if [ $RUN_SECONDARY = true ]; then 
    section "RUNNIG SECONDARY INSTALL"
    # Execute secondary script in the current shell without forking a sub shell
    . ./secondary
else 
    echo -e "Now go login to your accounts (Dropbox, emails, etc...) and then run secondary installs, \`bash secondary\`.\n"
fi